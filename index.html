<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Generador de Nota de Signatura</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f2f4f8;margin:0;padding:24px}
    .container{max-width:920px;margin:0 auto;background:#fff;padding:28px 24px;border-radius:16px;box-shadow:0 12px 40px rgba(16,24,40,.08)}
    h1{margin:0 0 6px;text-align:center;color:#1f2937;font-size:26px}
    .subtitle{margin:0 0 20px;text-align:center;color:#6b7280;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1 / -1}
    label{display:block;font-weight:600;color:#111827;margin-bottom:6px;font-size:14px}
    input,select,textarea{width:100%;padding:12px;border:1.8px solid #e5e7eb;border-radius:10px;font-size:15px;font-family:inherit;background:#fff;outline:none;transition:border-color .2s}
    textarea{min-height:140px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:#6366f1}
    .section{background:#f9fafb;border:1px solid #eef2f7;padding:16px;border-radius:12px;margin:18px 0}
    .section h3{margin:0 0 10px;font-size:16px;color:#1f2937}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:700;background:#6366f1;color:#fff;width:100%;font-size:16px;box-shadow:0 8px 20px rgba(99,102,241,.25);transition:transform .15s}
    .btn:hover{transform:translateY(-1px)}
    .btn-secondary{background:#111827}
    .btn-info{background:#0ea5e9}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .stack .btn{width:auto}
    .preview{margin-top:18px;display:none}
    .note{font-size:12px;color:#6b7280;margin-top:8px}
    .row-inline{display:flex;gap:12px;align-items:flex-end}
    .row-inline > div{flex:1}
    .hint{font-size:12px;color:#6b7280;margin-top:6px}
    #richDrop{padding:12px;border:1.8px dashed #cbd5e1;border-radius:10px;background:#fff;min-height:80px}
    #richDrop:focus{outline:none;border-color:#6366f1}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:12px}
    .thumb{border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;background:#fff}
    .thumb img{display:block;width:100%;height:100px;object-fit:contain;background:#f9fafb}
    .thumb .label{padding:6px 8px;font-size:12px;color:#374151;border-top:1px solid #eef2f7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    table.preview{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb}
    table.preview th, table.preview td{border:1px solid #e5e7eb;padding:6px 8px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pair{display:grid;grid-template-columns:1fr 1fr;gap:16px} /* para CLONA / TA */
    @media (max-width:760px){.grid{grid-template-columns:1fr}.row-inline{flex-direction:column}.pair{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìã Generador de Nota de Signatura</h1>
    <p class="subtitle">Complete los campos y genere el PDF con membrete y pie institucional</p>

    <!-- DATOS -->
    <div class="section">
      <h3>Datos del Convenio</h3>
      <div class="row-inline">
        <div>
          <label>Fecha (autom√°tica)</label>
          <input type="date" id="fecha" readonly>
        </div>
        <div>
          <label>N¬∫ de convenio (para autocompletar)</label>
          <div class="row-inline">
            <input type="text" id="numeroConvenioLookup" placeholder="Ej: 88">
            <button class="btn btn-secondary" style="width:auto" onclick="buscarDesdeSheets()">Buscar</button>
          </div>
          <div class="hint">Recorre todas las hojas del archivo y completa los campos si encuentra el n√∫mero.</div>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="full">
          <label>Nombre del Convenio</label>
          <input type="text" id="nombreConvenio">
        </div>
        <div class="full">
          <label>N√∫mero de Convenio</label>
          <input type="text" id="numeroConvenio">
        </div>
        <div>
          <label>Provincia</label>
          <input type="text" id="provincia">
        </div>
        <div>
          <label>Vigencia</label>
          <input type="date" id="vigencia">
        </div>
        <div class="full">
          <label>Correo del Convenio (prestador)</label>
          <input type="email" id="prestadorEmail">
        </div>
      </div>
    </div>

    <!-- CUERPO -->
    <div class="section">
      <h3>Cuerpo de la Nota</h3>
      <!-- Sin autogenerado obligatorio; editable por defecto -->
      <textarea id="cuerpoNota" placeholder="Escrib√≠ el cuerpo de la nota‚Ä¶"></textarea>
      <div class="hint">Pod√©s pegar im√°genes o grillas debajo; se insertan antes del bloque de firmas.</div>
    </div>

    <!-- ADJUNTOS -->
    <div class="section">
      <h3>Adjuntos (im√°genes / grillas)</h3>
      <div id="richDrop" contenteditable="true" placeholder="Peg√° ac√° im√°genes o tablas (Excel/Sheets). Tambi√©n pod√©s arrastrar archivos."></div>
      <div class="hint">Lo adjuntado se inserta antes del bloque de firmas y no lo deforma.</div>
      <div id="gallery" class="gallery"></div>
      <div id="tablesPreview"></div>
      <input type="file" id="imgInput" accept="image/*" multiple style="margin-top:10px">
      <input type="file" id="csvInput" accept=".csv" style="margin-top:10px">
    </div>

    <!-- FIRMANTES -->
    <div class="section">
      <h3>Firmantes</h3>
      <div class="grid">
        <div><label>Auxiliar</label><input id="auxiliar"></div>
        <div><label>Referente</label><input id="referente"></div>
        <div><label>Sub gerente del √°rea de convenios (opcional)</label><input id="subgerente"></div>
        <div><label>Jefa de convenios (opcional)</label><input id="jefaConvenios"></div>
        <div><label>Firmante del Convenio</label><input id="firmante"></div>
        <div><label>Cargo del Firmante</label><input id="cargoFirmante"></div>
      </div>
    </div>

    <!-- CLONA / TA -->
    <div class="section">
      <h3>CLONA y TA</h3>
      <div class="pair">
        <div>
          <label>CLONA ‚Äì ¬øcorresponde?</label>
          <select id="clona">
            <option value="NO">NO</option>
            <option value="SI">SI</option>
          </select>
          <label style="margin-top:8px">Convenios relacionados</label>
          <input id="conveniosClona" placeholder="Ej: CCT 123/75, CCT 456/80">
        </div>
        <div>
          <label>TA ‚Äì N√∫meros</label>
          <input type="text" id="numerosTA" placeholder="Ej: TA202272; TA202399‚Ä¶">
        </div>
      </div>
    </div>

    <div class="stack">
      <button class="btn" onclick="generarPDF()">üîÑ Generar PDF</button>
      <button class="btn btn-secondary" onclick="guardarEnSheet()">üíæ Guardar en Google Sheets</button>
      <button class="btn btn-info" onclick="enviarPorMail()">‚úâÔ∏è Enviar a Firmas</button>
    </div>
    <div class="note">Si aparece ‚ÄúConfigur√° WEBAPP_URL‚Ä¶‚Äù, reemplaz√° la constante WEBAPP_URL por la URL de tu Web App de Apps Script.</div>

    <div class="preview" id="preview">
      <p style="color:#10b981;font-weight:700;margin:10px 0 0">‚úÖ Documento listo:</p>
      <button class="btn" style="background:#10b981;margin-top:8px" onclick="descargarPDF()">üì• Descargar PDF</button>
    </div>
  </div>

  <!-- LIBRER√çAS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    /* ===================== CONFIG ===================== */
    const BASE = "https://conveniosjerarquicos.github.io/nota-signatura";
    const HEADER = `${BASE}/membrete.png`;
    const FOOTER = `${BASE}/pie.png`;

    // CSV publicado para todas las hojas
    const PUB_CSV_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTtwmE86YOrUU_3zaUAY2mXfwGrxe3f3sUdoI3ckQfj0cs3D1R46SzXH4tStGBiaVe6PiQFIR5DQ_U0/pub?single=true&output=csv&gid=";

    const SHEETS = [
      { name: "Juan Pablo Trossero", gid: "0" },
      // { name: "Nicol√°s Molli", gid: "XXXXXXXXXX" }, ...
    ];

    const REFERENTE_FIJO = "Leonardo Sibilia";

    // TODO: PON√â AC√Å TU URL REAL DEL WEB APP
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby8vNZmAdYVXplIam198xhFW0Qzo-YxFUqxpcSwVXtRvwAp_-wyYJuffO2rAxqnOT3unA/exec";

    /* ===================== ESTADO/UI ===================== */
    let headerImg, footerImg, pdfDoc = null;
    document.getElementById("fecha").value = new Date().toISOString().slice(0,10);

    /* ===================== ADJUNTOS ===================== */
    const imagesData = [];    // [{dataURL,w,h,name}]
    const tablesData = [];    // [ [row...] ]
    const gallery = document.getElementById('gallery');
    const tablesPreview = document.getElementById('tablesPreview');

    function addThumb(src, label){
      const div=document.createElement('div'); div.className='thumb';
      const img=document.createElement('img'); img.src=src; div.appendChild(img);
      const cap=document.createElement('div'); cap.className='label'; cap.textContent=label||'Imagen';
      div.appendChild(cap); gallery.appendChild(div);
    }
    function addTablePreview(rows){
      const wrapper=document.createElement('div'); wrapper.style.marginTop='10px';
      const tbl=document.createElement('table'); tbl.className='preview';
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      rows[0].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
      thead.appendChild(trh); tbl.appendChild(thead);
      const tb=document.createElement('tbody');
      rows.slice(1, Math.min(rows.length, 12)).forEach(r=>{
        const tr=document.createElement('tr');
        r.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
        tb.appendChild(tr);
      });
      tbl.appendChild(tb); wrapper.appendChild(tbl); tablesPreview.appendChild(wrapper);
    }

    const drop = document.getElementById('richDrop');
    ;['dragenter','dragover','dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault(); e.stopPropagation();}));

    // Pegar tablas/imagenes
    drop.addEventListener('paste', async (e)=>{
      e.preventDefault();
      const cd = e.clipboardData; if (!cd) return;
      let handled = false;

      // Im√°genes
      for (const item of cd.items){
        if (item.type.indexOf("image") === 0){
          const file = item.getAsFile();
          const dataURL = await fileToDataURL(file);
          const dim = await measureDataURL(dataURL);
          imagesData.push({dataURL, ...dim, name:file.name||'imagen'});
          addThumb(dataURL, file.name||'imagen');
          handled = true;
        }
      }

      // Tabla HTML
      const html = cd.getData("text/html");
      if (html && html.includes("<table")){
        const div=document.createElement("div"); div.innerHTML=html;
        const tbl = div.querySelector("table");
        if (tbl){
          const rows = [...tbl.rows].map(r => [...r.cells].map(c => c.innerText.trim()));
          if (rows.length && rows[0].length){
            tablesData.push(rows); addTablePreview(rows); handled = true;
          }
        }
      }

      // Texto tabulado (TSV)
      if (!handled){
        const text = cd.getData("text/plain");
        if (text && text.includes("\t")){
          const rows = text.split(/\r?\n/).filter(Boolean).map(line => line.split("\t").map(s=>s.trim()));
          if (rows.length && rows[0].length){
            tablesData.push(rows); addTablePreview(rows); handled = true;
          }
        }
      }
    });

    // Drag & drop im√°genes
    drop.addEventListener('drop', async (e)=>{
      const files = e.dataTransfer.files;
      for (const f of files){
        if (!f.type.startsWith('image/')) continue;
        const dataURL = await fileToDataURL(f);
        const dim = await measureDataURL(dataURL);
        imagesData.push({dataURL, ...dim, name:f.name||'imagen'});
        addThumb(dataURL, f.name||'imagen');
      }
    });

    document.getElementById('imgInput').addEventListener('change', async (e)=>{
      for (const f of e.target.files){
        const dataURL = await fileToDataURL(f);
        const dim = await measureDataURL(dataURL);
        imagesData.push({dataURL, ...dim, name:f.name||'imagen'});
        addThumb(dataURL, f.name||'imagen');
      }
    });

    // CSV ‚Üí tabla
    document.getElementById('csvInput').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if (!f) return;
      const text = await f.text();
      const parsed = Papa.parse(text, { skipEmptyLines: true });
      if (parsed.data && parsed.data.length){
        tablesData.push(parsed.data);
        addTablePreview(parsed.data);
      }
    });

    function fileToDataURL(file){
      return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(file); });
    }
    function measureDataURL(dataURL){
      return new Promise(res=>{ const img=new Image(); img.onload=()=>res({w:img.width,h:img.height}); img.src=dataURL; });
    }

    /* ===================== PDF ===================== */
    function loadImage(url){
      return new Promise((res,rej)=>{ const img=new Image(); img.crossOrigin="anonymous"; img.onload=()=>res(img); img.onerror=()=>rej(); img.src=url; });
    }
    async function ensureImages(){ if(!headerImg) headerImg=await loadImage(HEADER); if(!footerImg) footerImg=await loadImage(FOOTER); }

    const PAGE_W=210, PAGE_H=297, MARGIN_X=20, CONTENT_W=PAGE_W-MARGIN_X*2;
    const HEADER_H=14, FOOTER_H=12;
    function topY(){ return 10 + HEADER_H + 12; }
    function bottomY(){ return PAGE_H - FOOTER_H - 16; }
    function ensureSpace(doc, needed, yRef){
      if (yRef.value + needed > bottomY()){ doc.addPage(); addHeaderFooter(doc); yRef.value = topY(); }
    }
    function addHeaderFooter(doc){
      if (headerImg) doc.addImage(headerImg, "PNG", MARGIN_X, 10, CONTENT_W, HEADER_H);
      if (footerImg) doc.addImage(footerImg, "PNG", MARGIN_X, PAGE_H - FOOTER_H - 8, CONTENT_W, FOOTER_H);
    }
    function textBlock(doc, value, width, yRef, opt={}){
      const { fontSize=12, lineH=5.4, align="left", before=0, after=4, bold=false } = opt;
      const v = (value || "").toString().trim(); if (!v) return;
      yRef.value += before;
      doc.setFont("helvetica", bold ? "bold":"normal"); doc.setFontSize(fontSize);
      const lines = doc.splitTextToSize(v, width);
      const h = lines.length * lineH + 1;
      ensureSpace(doc, h, yRef);
      doc.text(lines, MARGIN_X, yRef.value, { align });
      yRef.value += h + after;
    }
    function textBlockAt(doc, value, x, width, yRef, opt={}){
      const { fontSize=12, lineH=5.4, bold=false, before=0, after=4 } = opt;
      const v = (value || "").toString().trim(); if(!v) return;
      yRef.value += before;
      const lines = doc.splitTextToSize(v, width);
      const h = lines.length * lineH + 1;
      if (yRef.value + h > bottomY()){ doc.addPage(); addHeaderFooter(doc); yRef.value = topY(); }
      doc.setFont("helvetica", bold?"bold":"normal"); doc.setFontSize(fontSize);
      doc.text(lines, x, yRef.value);
      yRef.value += h + after;
    }

    async function generarPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"mm", format:"a4" });
      await ensureImages();
      addHeaderFooter(doc);

      const fecha          = formatDateDMY(document.getElementById("fecha").value);
      const provincia      = document.getElementById("provincia").value;
      const nombreConvenio = document.getElementById("nombreConvenio").value;
      const numeroConvenio = document.getElementById("numeroConvenio").value;
      const prestadorEmail = document.getElementById("prestadorEmail").value;
      const cuerpoNota     = document.getElementById("cuerpoNota").value;

      const auxiliar       = document.getElementById("auxiliar").value;
      const referente      = (document.getElementById("referente").value || REFERENTE_FIJO);
      const subgerente     = document.getElementById("subgerente").value;
      const jefaConvenios  = document.getElementById("jefaConvenios").value;
      const firmante       = document.getElementById("firmante").value;
      const cargoFirmante  = document.getElementById("cargoFirmante").value;

      const clona          = document.getElementById("clona").value;
      const conveniosClona = document.getElementById("conveniosClona").value;
      const numerosTA      = document.getElementById("numerosTA").value;

      let y = { value: topY() };

      // Encabezado tipo carta
      textBlock(doc, fecha, CONTENT_W, y, {fontSize:12, after:6});
      textBlock(doc, nombreConvenio, CONTENT_W, y, {fontSize:12, after:2});
      textBlock(doc, `Convenio ${numeroConvenio} ‚Äì ${provincia}`, CONTENT_W, y, {fontSize:12, after:2});
      if (prestadorEmail.trim()!==""){ textBlock(doc, prestadorEmail, CONTENT_W, y, {fontSize:11, after:14}); } else { y.value += 14; }

      // separador
      ensureSpace(doc, 6, y); doc.setDrawColor(170); doc.setLineWidth(0.35);
      doc.line(MARGIN_X, y.value, PAGE_W - MARGIN_X, y.value); y.value += 16;

      // Cuerpo
      textBlock(doc, "A quien corresponda:", CONTENT_W, y, {fontSize:12, bold:true, after:10});
      textBlock(doc, cuerpoNota, CONTENT_W, y, {fontSize:12, lineH:5.6, after:24}); // M√ÅS espacio con firmas

      // ===== TABLAS (ocupan todo el ancho) =====
      for (const rows of tablesData){
        if (!rows || !rows.length || !rows[0]?.length) continue;

        ensureSpace(doc, 16, y);
        doc.autoTable({
          head: [rows[0]],
          body: rows.slice(1),
          startY: y.value,
          margin: { top: topY(), bottom: FOOTER_H + 14, left: MARGIN_X, right: MARGIN_X },
          styles: { font: 'helvetica', fontSize: 10, cellPadding: 3, lineWidth: 0.15, overflow: 'linebreak' },
          headStyles: { fillColor: [247,248,250], textColor: 0, lineWidth: 0.2 },
          tableWidth: CONTENT_W,
          pageBreak: 'auto',
          didDrawPage: () => addHeaderFooter(doc)
        });
        const finalY = (doc.lastAutoTable && doc.lastAutoTable.finalY) ? doc.lastAutoTable.finalY : y.value;
        y.value = finalY + 12;
      }

      // IM√ÅGENES (si hubiera) ‚Äì en tama√±o grande sin pisar firmas
      for (const img of imagesData){
        const maxW = CONTENT_W, maxH = 140;
        let w = maxW, h = w * (img.h/img.w);
        if (h > maxH){ h = maxH; w = h * (img.w/img.h); }
        ensureSpace(doc, h+8, y);
        doc.addImage(img.dataURL, "PNG", MARGIN_X, y.value, w, h);
        y.value += h + 10;
      }

      // ===== Firmas en 2 columnas =====
      const columnGap = 14, colW = (CONTENT_W - columnGap) / 2;
      const xLeft = MARGIN_X, xRight = MARGIN_X + colW + columnGap;
      let yLeft = { value: y.value }, yRight = { value: y.value };

      textBlockAt(doc, "Por Jer√°rquicos Salud:", xLeft, colW, yLeft, {bold:true, fontSize:12, after:8});
      textBlockAt(doc, `${auxiliar} ‚Äî Comercial de Convenios`, xLeft, colW, yLeft, {fontSize:12, after:6});
      textBlockAt(doc, `${referente} ‚Äî Referente del √Årea Comercial de Convenios`, xLeft, colW, yLeft, {fontSize:12, after:6});
      if (subgerente.trim()!==""){ textBlockAt(doc, `${subgerente} ‚Äî Sub gerente del √°rea de convenios`, xLeft, colW, yLeft, {fontSize:12, after:6}); }
      if (jefaConvenios.trim()!==""){ textBlockAt(doc, `${jefaConvenios} ‚Äî Jefa de convenios`, xLeft, colW, yLeft, {fontSize:12, after:6}); }

      textBlockAt(doc, "Por el Convenio:", xRight, colW, yRight, {bold:true, fontSize:12, after:8});
      const firmaConCargo = [firmante, cargoFirmante].filter(Boolean).join(" ‚Äî ");
      textBlockAt(doc, firmaConCargo, xRight, colW, yRight, {fontSize:12, after:6});

      y.value = Math.max(yLeft.value, yRight.value) + 14;

      // ===== CLONA / TA en dos columnas (misma l√≠nea) =====
      const pairW = (CONTENT_W - 10) / 2;
      const xA = MARGIN_X, xB = MARGIN_X + pairW + 10;
      let yA = { value: y.value }, yB = { value: y.value };

      // CLONA (solo si SI o hay detalle)
      if (clona === "SI" || (conveniosClona||"").trim()!==""){
        textBlockAt(doc, "CLONA:", xA, pairW, yA, {fontSize:10, bold:true, after:2});
        const clonaText = (clona === "SI" && (conveniosClona||"").trim()!=="") ? conveniosClona : (clona === "SI" ? "S√≠" : "");
        textBlockAt(doc, clonaText, xA, pairW, yA, {fontSize:10, after:0});
      }

      // TA (si hay)
      if ((numerosTA||"").trim()!==""){
        textBlockAt(doc, "TA:", xB, pairW, yB, {fontSize:10, bold:true, after:2});
        textBlockAt(doc, numerosTA, xB, pairW, yB, {fontSize:10, after:0});
      }

      y.value = Math.max(yA.value, yB.value);

      pdfDoc = doc;
      document.getElementById("preview").style.display = "block";
      document.getElementById("preview").scrollIntoView({behavior:"smooth"});
    }

    function descargarPDF(){
      if(!pdfDoc) return;
      const numero   = (document.getElementById('numeroConvenio').value || "").trim();
      const nombre   = (document.getElementById('nombreConvenio').value || "").trim();
      const vigencia = (document.getElementById('vigencia').value || "").trim();
      const safe = s => s.replace(/\s+/g,' ').replace(/[/\\:*?"<>|]+/g,'_').trim();
      const file = `${safe(numero)} - ${safe(nombre)} - ${safe(vigencia)}` || 'NotaSignatura';
      pdfDoc.save(`${file}.pdf`);
    }
    function formatDateDMY(iso){ if(!iso) return ""; const [y,m,d]=iso.split("-"); return `${d.padStart(2,"0")}/${m.padStart(2,"0")}/${y}`; }

    /* ====== AUTOCOMPLETAR MULTI-HOJA (CSV por gid) ====== */
    const norm = (s) => String(s || "")
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .toLowerCase().replace(/[^a-z0-9]+/g, " ").trim().replace(/\s+/g, " ");

    function buildHeaderIndex(headers) {
      const map = {};
      headers.forEach((h, i) => {
        const n = norm(h);
        if (/(^| )numero( | )de( | )convenio( |$)/.test(n))        map["numeroconvenio"] = i;
        else if (/(^| )nombre( | )del( | )convenio( |$)/.test(n))  map["nombreconvenio"] = i;
        else if (/^provincia$/.test(n))                            map["provincia"] = i;
        else if (/(^| )correo( | )del( | )convenio( |$)/.test(n))  map["prestadoremail"] = i;
        else if (/(^| )nombre( | )del( | )auxiliar( |$)/.test(n))  map["auxiliar"] = i;
        else if (/(^| )nombre( | )del( | )referente( |$)/.test(n)) map["referente"] = i;
        else if (/(^| )subgerente( |$)/.test(n))                   map["subgerente"] = i;
        else if (/(^| )jefa( | )de( | )convenios/.test(n))         map["jefa"] = i;
        else if (/(^| )nombre( | )del( | )firmante( | )del( | )convenio/.test(n)) map["firmante"] = i;
        else if (/(^| )cargo( | )del( | )firmante/.test(n))        map["cargofirmante"] = i;
        else if (/^vigencia$/.test(n))                             map["vigencia"] = i;
        else if (/(^| )cuerpo( | )de( | )la( | )nota( |$)/.test(n)) map["cuerponota"] = i;
      });
      return map;
    }

    async function fetchSheetCSV(gid){
      const url = PUB_CSV_BASE + encodeURIComponent(gid);
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.text();
    }

    function setIf(id, v){ if (v !== undefined && v !== null && String(v).trim() !== "") document.getElementById(id).value = v; }
    function toISO(dmy){
      const s = String(dmy).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (m){ const [_, d, mo, y] = m; return `${y}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`; }
      return "";
    }

    async function buscarDesdeSheets(){
      const numero = (document.getElementById("numeroConvenioLookup").value || "").trim();
      if (!numero){ alert("Ingres√° un n√∫mero de convenio"); return; }

      for (const s of SHEETS){
        try{
          const csv = await fetchSheetCSV(s.gid);
          const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
          const rows = parsed.data;
          if (!rows?.length) continue;

          const headers = parsed.meta.fields || Object.keys(rows[0]);
          const idx = buildHeaderIndex(headers);
          const get = (row, key) => { const i = idx[key]; if (i == null) return ""; const headerReal = headers[i]; return row[headerReal] ?? ""; };

          const found = rows.find(r => norm(get(r, "numeroconvenio")) === norm(numero));
          if (!found) continue;

          setIf("numeroConvenio",  get(found, "numeroconvenio"));
          setIf("nombreConvenio",  get(found, "nombreconvenio"));
          setIf("provincia",       get(found, "provincia"));
          setIf("prestadorEmail",  get(found, "prestadoremail"));
          setIf("auxiliar",        get(found, "auxiliar") || s.name);
          setIf("referente",       get(found, "referente") || REFERENTE_FIJO);
          setIf("subgerente",      get(found, "subgerente"));
          setIf("jefaConvenios",   get(found, "jefa"));
          setIf("firmante",        get(found, "firmante"));
          setIf("cargoFirmante",   get(found, "cargofirmante"));

          const vig = get(found, "vigencia");
          if (vig) document.getElementById("vigencia").value = toISO(vig);

          const cuerpo = get(found, "cuerponota");
          if (cuerpo){
            const ta = document.getElementById('cuerpoNota');
            ta.value = [ta.value.trim(), cuerpo].filter(Boolean).join("\n\n");
          }

          alert(`‚úî Datos completados (hoja: ${s.name})`);
          return;
        }catch(e){ console.warn("No pude leer gid", s.gid, e); }
      }
      alert("No se encontr√≥ ese n√∫mero en ninguna hoja.");
    }

    /* ====== Guardado a Google Sheets / Env√≠o mail ====== */
    async function guardarEnSheet(){
      if (!WEBAPP_URL || WEBAPP_URL.includes("TU_DEPLOY_ID")){
        alert("Configur√° WEBAPP_URL con la URL del Web App de Apps Script.");
        return;
      }
      const payload = {
        // la pesta√±a se resuelve en tu Apps Script por 'comercial' si quer√©s
        comercial:      document.getElementById('auxiliar').value || 'Auxiliar',
        numeroConvenio: document.getElementById('numeroConvenio').value,
        nombreConvenio: document.getElementById('nombreConvenio').value,
        provincia:      document.getElementById('provincia').value,
        vigencia:       document.getElementById('vigencia').value,
        prestadorEmail: document.getElementById('prestadorEmail').value,
        cuerpoNota:     document.getElementById('cuerpoNota').value,

        auxiliar:       document.getElementById('auxiliar').value,
        referente:      document.getElementById('referente').value || REFERENTE_FIJO,
        subgerente:     document.getElementById('subgerente').value,
        jefaConvenios:  document.getElementById('jefaConvenios').value,
        firmante:       document.getElementById('firmante').value,
        cargoFirmante:  document.getElementById('cargoFirmante').value,

        clona:          document.getElementById('clona').value,
        conveniosClona: document.getElementById('conveniosClona').value,
        numerosTA:      document.getElementById('numerosTA').value,

        tablas:   tablesData,
        imagenes: imagesData.map(({dataURL, name}) => ({dataURL,name}))
      };

      try{
        const res = await fetch(WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(()=>({ok:false, error:'Respuesta no JSON'}));
        if (data.ok){
          alert("‚úî Guardado en Google Sheets");
        } else {
          alert("No se pudo guardar: " + (data.error || res.status));
        }
      }catch(err){
        alert("Error de red guardando en Sheets: " + err.message);
      }
    }

    async function enviarPorMail(){
      if (!WEBAPP_URL || WEBAPP_URL.includes("TU_DEPLOY_ID")){
        alert("Configur√° WEBAPP_URL con la URL del Web App de Apps Script.");
        return;
      }
      if (!pdfDoc) await generarPDF();
      if (!pdfDoc) { alert("No se pudo generar el PDF."); return; }

      const numero   = (document.getElementById('numeroConvenio').value || "").trim();
      const nombre   = (document.getElementById('nombreConvenio').value || "").trim();
      const vigencia = (document.getElementById('vigencia').value || "").trim();
      const correoAux = (document.getElementById('prestadorEmail').value || "").trim();

      const auxiliar    = (document.getElementById('auxiliar').value || "").trim();
      const referente   = (document.getElementById('referente').value || "").trim();
      const subgerente  = (document.getElementById('subgerente').value || "").trim();
      const jefa        = (document.getElementById('jefaConvenios').value || "").trim();

      const to = "firmaselectronicas@jerarquicos.com";
      const subject = `${numero} - ${nombre} - ${vigencia}`;
      const lista = [auxiliar, referente, subgerente, jefa, correoAux].filter(Boolean).join(", ");
      const bodyText = `Hola, buenos d√≠as:

Paso para subir a plataforma con los siguientes firmantes:
${lista}

Saludos.`;
      const bodyHtml = `<p>Hola, buenos d√≠as:</p><p>Paso para subir a plataforma con los siguientes firmantes:</p><p>${lista}</p><p>Saludos.</p>`;

      const pdfDataUrl = pdfDoc.output('datauristring');
      const filename = `${subject}.pdf`.replace(/[\/\\:*?"<>|]+/g,'_');

      try{
        const res = await fetch(WEBAPP_URL, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ action:"sendEmail", to, subject, bodyText, bodyHtml, filename, pdfDataUrl })
        });
        const data = await res.json().catch(()=>({ok:false}));
        if (data.ok){ alert("‚úî Correo enviado a firmaselectronicas@jerarquicos.com"); }
        else { alert("No se pudo enviar el correo: " + (data.error || res.status)); }
      }catch(err){ alert("Error enviando mail: " + err.message); }
    }
  </script>
</body>
</html>
