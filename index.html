<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Generador de Nota de Signatura</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f2f4f8;margin:0;padding:24px}
    .container{max-width:920px;margin:0 auto;background:#fff;padding:28px 24px;border-radius:16px;box-shadow:0 12px 40px rgba(16,24,40,.08)}
    h1{margin:0 0 6px;text-align:center;color:#1f2937;font-size:26px}
    .subtitle{margin:0 0 20px;text-align:center;color:#6b7280;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1 / -1}
    label{display:block;font-weight:600;color:#111827;margin-bottom:6px;font-size:14px}
    input,select,textarea{width:100%;padding:12px;border:1.8px solid #e5e7eb;border-radius:10px;font-size:15px;font-family:inherit;background:#fff;outline:none;transition:border-color .2s}
    textarea{min-height:140px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:#6366f1}
    .section{background:#f9fafb;border:1px solid #eef2f7;padding:16px;border-radius:12px;margin:18px 0}
    .section h3{margin:0 0 10px;font-size:16px;color:#1f2937}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:700;background:#6366f1;color:#fff;width:100%;font-size:16px;box-shadow:0 8px 20px rgba(99,102,241,.25);transition:transform .15s}
    .btn:hover{transform:translateY(-1px)}
    .preview{margin-top:18px;display:none}
    .note{font-size:12px;color:#6b7280;margin-top:8px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìã Generador de Nota de Signatura</h1>
    <p class="subtitle">Complete los campos y genere el PDF con membrete y pie institucional</p>

    <!-- DATOS -->
    <div class="section">
      <h3>Datos del Convenio</h3>
      <div class="grid">
        <div>
          <label>Fecha</label>
          <input type="date" id="fecha">
        </div>
        <div>
          <label>Provincia</label>
          <input type="text" id="provincia" placeholder="Ej: Santa Fe">
        </div>
        <div class="full">
          <label>Nombre del Convenio</label>
          <input type="text" id="nombreConvenio" placeholder="Ej: Convenio Colectivo de Trabajo - Industria...">
        </div>
        <div class="full">
          <label>N√∫mero de Convenio</label>
          <input type="text" id="numeroConvenio" placeholder="Ej: 260/75">
        </div>
        <div class="full">
          <label>Vigencia</label>
          <input type="text" id="vigencia" placeholder="Ej: 01/09/2025">
        </div>
      </div>
    </div>

    <!-- CUERPO -->
    <div class="section">
      <h3>Cuerpo de la Nota</h3>
      <div>
        <label>Texto</label>
        <textarea id="cuerpoNota" placeholder="Escriba el contenido principal de la nota..."></textarea>
      </div>
    </div>

    <!-- FIRMANTES -->
    <div class="section">
      <h3>Firmantes</h3>
      <div class="grid">
        <div>
          <label>Nombre del Auxiliar</label>
          <input type="text" id="auxiliar" placeholder="Nombre completo">
        </div>
        <div>
          <label>Nombre del Referente</label>
          <input type="text" id="referente" placeholder="Nombre completo">
        </div>
        <div class="full">
          <label>Nombre del Subgerente (opcional)</label>
          <input type="text" id="subgerente" placeholder="Dejar en blanco si no corresponde">
        </div>
        <div>
          <label>Nombre del Firmante del Convenio</label>
          <input type="text" id="firmante" placeholder="Nombre completo">
        </div>
        <div>
          <label>Cargo del Firmante del Convenio</label>
          <input type="text" id="cargoFirmante" placeholder="Ej: Director, Presidente, etc.">
        </div>
        <div class="full">
          <label>Correo electr√≥nico del convenio (prestador)</label>
          <input type="email" id="prestadorEmail" placeholder="ejemplo@dominio.com">
        </div>
      </div>
    </div>

    <!-- CLONA -->
    <div class="section">
      <h3>CLONA</h3>
      <div class="grid">
        <div>
          <label>¬øCorresponde?</label>
          <select id="clona" onchange="toggleClona()">
            <option value="NO">NO</option>
            <option value="SI">SI</option>
          </select>
        </div>
        <div class="full" id="clonaBox" style="display:none;">
          <label>Convenios relacionados (si corresponde)</label>
          <textarea id="conveniosClona" placeholder="Ej: CCT 123/75, CCT 456/80"></textarea>
        </div>
      </div>
    </div>

    <!-- TA -->
    <div class="section">
      <h3>TA (Tasa Acumulada)</h3>
      <label>N√∫meros de TA</label>
      <input type="text" id="numerosTA" placeholder="Ej: TA2024171; TA202517.99">
    </div>

    <button class="btn" onclick="generarPDF()">üîÑ Generar PDF</button>
    <div class="note">Formato carta; firmas en dos columnas; ‚ÄúCLONA/TA‚Äù al pie en letra m√°s chica.</div>

    <div class="preview" id="preview">
      <p style="color:#10b981;font-weight:700;margin:10px 0 0">‚úÖ Documento listo. Pod√©s descargarlo:</p>
      <button class="btn" style="background:#10b981;margin-top:8px" onclick="descargarPDF()">üì• Descargar PDF</button>
    </div>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // üîó PON√â TUS URLs RAW (formato correcto):
    // https://raw.githubusercontent.com/conveniosjerarquicos/nota-signatura/main/membrete.png
    // https://raw.githubusercontent.com/conveniosjerarquicos/nota-signatura/main/pie.png
    const HEADER_URL = "https://raw.githubusercontent.com/conveniosjerarquicos/nota-signatura/main/membrete.png";
    const FOOTER_URL = "https://raw.githubusercontent.com/conveniosjerarquicos/nota-signatura/main/pie.png";

    // --- Config p√°gina ---
    const PAGE_W = 210, PAGE_H = 297;
    const MARGIN_X = 20;
    const CONTENT_W = PAGE_W - MARGIN_X * 2;

    // Membrete/Pie dentro de m√°rgenes
    const HEADER_MAX_H = 14;
    const FOOTER_MAX_H = 12;
    let headerDataURL = null, footerDataURL = null;
    let headerH = 10, footerH = 10;

    // Espaciados
    const GAP_AFTER_HEADER  = 14;
    const GAP_AFTER_BODY    = 18;
    const GAP_BETWEEN_SIGS  = 10;
    const GAP_TO_FOOT_NOTES = 18;

    function toggleClona(){
      const v = document.getElementById('clona').value;
      document.getElementById('clonaBox').style.display = (v === 'SI') ? 'block' : 'none';
    }

    // Helpers -----------------------------------------------------
    function formatDateDMY(iso) {
      if (!iso) return "";
      const [y, m, d] = iso.split("-");
      return `${d.padStart(2,"0")}/${m.padStart(2,"0")}/${y}`;
    }

    async function toDataURL(url){
      try{
        const r = await fetch(url, {mode:'cors'});
        if(!r.ok) throw new Error(r.status);
        const b = await r.blob();
        return await new Promise(res => {
          const fr = new FileReader();
          fr.onload = () => res(fr.result);
          fr.readAsDataURL(b);
        });
      }catch(e){
        console.warn("No se pudo cargar imagen:", url, e);
        return null;
      }
    }

    async function ensureHeaderFooterLoaded(){
      if (!headerDataURL) headerDataURL = await toDataURL(HEADER_URL);
      if (!footerDataURL) footerDataURL = await toDataURL(FOOTER_URL);

      async function measure(dataURL){
        if(!dataURL) return null;
        return await new Promise(res=>{
          const img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = () => res({w: img.width, h: img.height});
          img.onerror = () => res(null);
          img.src = dataURL;
        });
      }
      const hs = await measure(headerDataURL);
      if (hs && hs.w) headerH = Math.min(CONTENT_W * (hs.h/hs.w), HEADER_MAX_H);

      const fs = await measure(footerDataURL);
      if (fs && fs.w) footerH = Math.min(CONTENT_W * (fs.h/fs.w), FOOTER_MAX_H);
    }

    function addHeaderFooter(doc){
      if (headerDataURL) doc.addImage(headerDataURL, "PNG", MARGIN_X, 10, CONTENT_W, headerH);
      if (footerDataURL) doc.addImage(footerDataURL, "PNG", MARGIN_X, PAGE_H - footerH - 8, CONTENT_W, footerH);
    }

    function topY(){ return 10 + (headerDataURL ? headerH : 0) + 12; }
    function bottomY(){ return PAGE_H - (footerDataURL ? footerH : 0) - 16; }

    function ensureSpace(doc, needed, yRef){
      if (yRef.value + needed > bottomY()){
        doc.addPage(); addHeaderFooter(doc); yRef.value = topY();
      }
    }

    // Texto a una columna
    function textBlock(doc, value, width, yRef, opt={}){
      const { fontSize=12, lineH=5.4, align="left", before=0, after=4, bold=false } = opt;
      const v = (value || "").toString().trim();
      if (!v) return;
      yRef.value += before;
      doc.setFont(undefined, bold ? "bold" : "normal");
      doc.setFontSize(fontSize);
      const lines = doc.splitTextToSize(v, width);
      const h = lines.length * lineH + 1;
      ensureSpace(doc, h, yRef);
      doc.text(lines, MARGIN_X, yRef.value, { align });
      yRef.value += h + after;
    }

    // Texto posicionable (para columnas)
    function textBlockAt(doc, value, x, width, yRef, opt={}){
      const { fontSize=12, lineH=5.4, bold=false, before=0, after=4 } = opt;
      const v = (value || "").toString().trim(); if(!v) return;
      yRef.value += before;
      const lines = doc.splitTextToSize(v, width);
      const h = lines.length * lineH + 1;
      if (yRef.value + h > bottomY()){
        doc.addPage(); addHeaderFooter(doc);
        yRef.value = topY();
      }
      doc.setFont(undefined, bold ? "bold" : "normal");
      doc.setFontSize(fontSize);
      doc.text(lines, x, yRef.value);
      yRef.value += h + after;
    }

    // -------------------------------------------------------------
    let pdfDoc = null;

    async function generarPDF(){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "mm", format: "a4" });

        await ensureHeaderFooterLoaded();
        addHeaderFooter(doc);

        // Captura del formulario
        const fecha          = formatDateDMY(document.getElementById('fecha').value);
        const provincia      = document.getElementById('provincia').value;
        const nombreConvenio = document.getElementById('nombreConvenio').value;
        const numeroConvenio = document.getElementById('numeroConvenio').value;
        const vigencia       = document.getElementById('vigencia').value;

        const cuerpoNota     = document.getElementById('cuerpoNota').value;

        const auxiliar       = document.getElementById('auxiliar').value;
        const referente      = document.getElementById('referente').value;
        const subgerente     = document.getElementById('subgerente').value;
        const firmante       = document.getElementById('firmante').value;
        const cargoFirmante  = document.getElementById('cargoFirmante').value;
        const prestadorEmail = document.getElementById('prestadorEmail').value;

        const clona          = document.getElementById('clona').value;
        const conveniosClona = document.getElementById('conveniosClona').value;
        const numerosTA      = document.getElementById('numerosTA').value;

        // === Composici√≥n tipo carta ===
        let y = { value: topY() };

        // Encabezado (fecha y datos)
        textBlock(doc, fecha, CONTENT_W, y, {fontSize:12, after:6});
        textBlock(doc, nombreConvenio, CONTENT_W, y, {fontSize:12, after:2});
        textBlock(doc, `Convenio ${numeroConvenio} ‚Äì ${provincia}`, CONTENT_W, y, {fontSize:12, after:2});
        if ((prestadorEmail||"").trim()!==""){
          textBlock(doc, prestadorEmail, CONTENT_W, y, {fontSize:11, after:GAP_AFTER_HEADER});
        } else {
          y.value += GAP_AFTER_HEADER;
        }

        // separador suave
        ensureSpace(doc, 6, y);
        doc.setDrawColor(170); doc.setLineWidth(0.35);
        doc.line(MARGIN_X, y.value, PAGE_W - MARGIN_X, y.value);
        y.value += GAP_AFTER_HEADER;

        // A quien corresponda
        textBlock(doc, "A quien corresponda:", CONTENT_W, y, {fontSize:12, bold:true, after:10});

        // Cuerpo
        textBlock(doc, cuerpoNota, CONTENT_W, y, {fontSize:12, lineH:5.6, after:GAP_AFTER_BODY});

        // ===== Firmantes en dos columnas =====
        const columnGap = 12;
        const colW = (CONTENT_W - columnGap) / 2;
        const xLeft = MARGIN_X;
        const xRight = MARGIN_X + colW + columnGap;

        let yLeft = { value: y.value };
        let yRight = { value: y.value };

        // Columna izquierda: Jer√°rquicos
        textBlockAt(doc, "Por Jer√°rquicos Salud:", xLeft, colW, yLeft, {bold:true, fontSize:12, after:GAP_BETWEEN_SIGS});
        textBlockAt(doc, `${auxiliar} ‚Äî Comercial de Convenios`, xLeft, colW, yLeft, {fontSize:12, after:6});
        textBlockAt(doc, `${referente} ‚Äî Referente del √Årea Comercial de Convenios`, xLeft, colW, yLeft, {fontSize:12, after:6});

        // Columna derecha: Prestador
        textBlockAt(doc, "Por el Convenio:", xRight, colW, yRight, {bold:true, fontSize:12, after:GAP_BETWEEN_SIGS});
        // Nombre + Cargo en la misma l√≠nea
        const firmaConCargo = [firmante, cargoFirmante].filter(Boolean).join(" ‚Äî ");
        textBlockAt(doc, firmaConCargo, xRight, colW, yRight, {fontSize:12, after:6});

        // (El correo ya va en el encabezado, no lo repetimos aqu√≠)
        if ((subgerente||"").trim()!==""){
          textBlockAt(doc, `${subgerente} ‚Äî Sub gerente`, xRight, colW, yRight, {fontSize:12, after:6});
        }

        // Continuamos desde el mayor Y de las dos columnas
        y.value = Math.max(yLeft.value, yRight.value) + GAP_TO_FOOT_NOTES;

        // ===== CLONA y TA al pie =====
        if (clona === "SI" && (conveniosClona||"").trim()!==""){
          textBlock(doc, "CLONA", CONTENT_W, y, {fontSize:10, bold:true, after:4});
          textBlock(doc, conveniosClona, CONTENT_W, y, {fontSize:10, lineH:4.6, after:8});
        }
        if ((numerosTA||"").trim()!==""){
          textBlock(doc, "TA", CONTENT_W, y, {fontSize:10, bold:true, after:4});
          textBlock(doc, numerosTA, CONTENT_W, y, {fontSize:10, lineH:4.6, after:2});
        }

        pdfDoc = doc;
        document.getElementById('preview').style.display = 'block';
        document.getElementById('preview').scrollIntoView({ behavior:'smooth' });

      } catch (err) {
        console.error(err);
        alert("Hubo un error generando el PDF. Revis√° la consola para m√°s detalles.");
      }
    }

    function descargarPDF(){
      if (pdfDoc){
        const numero   = (document.getElementById('numeroConvenio').value || "").trim();
        const nombre   = (document.getElementById('nombreConvenio').value || "").trim();
        const vigencia = (document.getElementById('vigencia').value || "").trim();
        const safe = s => s.replace(/\s+/g,' ').replace(/[/\\:*?"<>|]+/g,'_').trim();
        const file = `${safe(numero)} - ${safe(nombre)} - ${safe(vigencia)}` || 'NotaSignatura';
        pdfDoc.save(`${file}.pdf`);
      }
    }

    window.generarPDF = generarPDF;
    window.descargarPDF = descargarPDF;
  </script>
</body>
</html>
