<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  // 游녤 REEMPLAZA estas URLs por las tuyas (raw de GitHub)
  const HEADER_URL = "https://raw.githubusercontent.com/conveniosjerarquicos/nota-signatura/main/membrete.png";
  const FOOTER_URL = "https://raw.githubusercontent.com/conveniosjerarquicos/nota-signatura/main/pie.png";

  // Medidas A4 en jsPDF (mm)
  const PAGE_W = 210;
  const PAGE_H = 297;

  // Alturas del membrete y del pie (ajust치 a tu dise침o)
  const HEADER_H = 35;   // alto del header
  const FOOTER_H = 22;   // alto del footer
  const MARGIN_X = 20;   // margen horizontal de texto
  const TOP_Y   =  HEADER_H + 10;                 // inicio del contenido
  const BOTTOM_Y = PAGE_H - FOOTER_H - 10;        // l칤mite antes del pie

  // Pre-cargamos im치genes para no tener problemas as칤ncronos al generar
  let headerImg = null;
  let footerImg = null;
  let imagesReady = false;

  function loadImage(src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous"; // por si se sirve desde raw.githubusercontent
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = src;
    });
  }

  (async function preload() {
    try {
      [headerImg, footerImg] = await Promise.all([
        loadImage(HEADER_URL),
        loadImage(FOOTER_URL)
      ]);
      imagesReady = true;
    } catch (e) {
      console.error("No se pudieron cargar las im치genes de membrete/pie:", e);
    }
  })();

  function addHeaderFooter(doc) {
    // Header
    if (headerImg) {
      doc.addImage(headerImg, "PNG", 0, 0, PAGE_W, HEADER_H);
    }
    // Footer
    if (footerImg) {
      doc.addImage(footerImg, "PNG", 0, PAGE_H - FOOTER_H, PAGE_W, FOOTER_H);
    }
  }

  function ensureSpace(doc, needed, yRef) {
    // Si no hay espacio suficiente en la p치gina, crea una nueva y vuelve a dibujar header/footer
    if (yRef.value + needed > BOTTOM_Y) {
      doc.addPage();
      addHeaderFooter(doc);
      yRef.value = TOP_Y;
    }
  }

  function writeLabelValue(doc, label, value, yRef) {
    doc.setFont(undefined, "bold");
    doc.text(label, MARGIN_X, yRef.value);
    doc.setFont(undefined, "normal");
    doc.text(value || "-", MARGIN_X + 30, yRef.value);
    yRef.value += 7;
  }

  function writeBlock(doc, title, text, width, yRef) {
    doc.setFont(undefined, "bold");
    doc.text(title, MARGIN_X, yRef.value);
    yRef.value += 7;

    doc.setFont(undefined, "normal");
    const lines = doc.splitTextToSize(text || "-", width);
    // Altura aproximada del bloque
    const blockHeight = lines.length * 5 + 2;
    ensureSpace(doc, blockHeight, yRef);
    doc.text(lines, MARGIN_X, yRef.value);
    yRef.value += blockHeight + 3;
  }

  let pdfDoc = null;

  function generarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });

    // Si por alguna raz칩n no se cargaron, seguimos, pero sin header/pie
    addHeaderFooter(doc);

    // Captura de datos del formulario
    const fecha          = document.getElementById('fecha').value;
    const provincia      = document.getElementById('provincia').value;
    const nombreConvenio = document.getElementById('nombreConvenio').value;
    const numeroConvenio = document.getElementById('numeroConvenio').value;
    const cuerpoNota     = document.getElementById('cuerpoNota').value;
    const auxiliar       = document.getElementById('auxiliar').value;
    const referente      = document.getElementById('referente').value;
    const subgerente     = document.getElementById('subgerente').value;
    const firmante       = document.getElementById('firmante').value;
    const clona          = document.getElementById('clona').value;
    const conveniosClona = document.getElementById('conveniosClona').value;
    const numerosTA      = document.getElementById('numerosTA').value;

    // T칤tulo
    let y = { value: TOP_Y }; // usamos objeto para pasar por referencia
    doc.setFontSize(16);
    doc.setFont(undefined, "bold");
    doc.text("NOTA DE SIGNATURA", PAGE_W / 2, y.value, { align: "center" });
    y.value += 6;

    // L칤nea decorativa
    doc.setDrawColor(102, 126, 234);
    doc.setLineWidth(0.5);
    doc.line(MARGIN_X, y.value, PAGE_W - MARGIN_X, y.value);
    y.value += 8;

    doc.setFontSize(11);

    // Fila Fecha/Provincia
    ensureSpace(doc, 14, y);
    doc.setFont(undefined, "bold");
    doc.text("FECHA:", MARGIN_X, y.value);
    doc.setFont(undefined, "normal");
    doc.text(fecha || "-", MARGIN_X + 25, y.value);

    doc.setFont(undefined, "bold");
    doc.text("PROVINCIA:", PAGE_W - MARGIN_X - 60, y.value);
    doc.setFont(undefined, "normal");
    doc.text(provincia || "-", PAGE_W - MARGIN_X - 25, y.value);
    y.value += 10;

    // Convenio (nombre y n칰mero)
    writeBlock(doc, "CONVENIO:", nombreConvenio, PAGE_W - MARGIN_X * 2 - 30, y);
    writeLabelValue(doc, "N춿 CONVENIO:", numeroConvenio, y);

    // Cuerpo
    y.value += 5;
    writeBlock(doc, "CUERPO DE LA NOTA:", cuerpoNota, PAGE_W - MARGIN_X * 2, y);

    // Firmantes
    y.value += 3;
    doc.setFont(undefined, "bold");
    doc.text("FIRMANTES:", MARGIN_X, y.value);
    y.value += 7;
    doc.setFont(undefined, "normal");

    writeLabelValue(doc, "Auxiliar:", auxiliar, y);
    writeLabelValue(doc, "Referente:", referente, y);
    if ((subgerente || "").trim() !== "") {
      writeLabelValue(doc, "Subgerente:", subgerente, y);
    }
    writeLabelValue(doc, "Firmante del Convenio:", firmante, y);

    // CLONA
    y.value += 5;
    writeLabelValue(doc, "CLONA:", clona, y);
    if (clona === "SI" && (conveniosClona || "").trim() !== "") {
      writeBlock(doc, "Convenios Relacionados:", conveniosClona, PAGE_W - MARGIN_X * 2, y);
    }

    // TA
    y.value += 3;
    writeLabelValue(doc, "TA (Tasa Acumulada):", numerosTA, y);

    pdfDoc = doc;

    // Mostrar UI de descarga
    document.getElementById('preview').style.display = 'block';
    document.getElementById('preview').scrollIntoView({ behavior: 'smooth' });
  }

  function descargarPDF() {
    if (pdfDoc) {
      const numeroConvenio = (document.getElementById('numeroConvenio').value || "").replace(/[^a-zA-Z0-9]/g, "_");
      pdfDoc.save(`NotaSignatura_${numeroConvenio || "sin_numero"}.pdf`);
    }
  }

  // Exponemos las funciones a los botones
  window.generarPDF = generarPDF;
  window.descargarPDF = descargarPDF;
</script>
