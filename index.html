<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  // 👉 URLs RAW de tus imágenes en GitHub
  const HEADER_URL = "https://raw.githubusercontent.com/conveniosjerarquicos/nota-signatura/main/membrete.png";
  const FOOTER_URL = "https://raw.githubusercontent.com/conveniosjerarquicos/nota-signatura/main/pie.png";

  // --- Constantes de página ---
  const PAGE_W = 210, PAGE_H = 297;      // A4 mm
  const MARGIN_X = 20;
  const CONTENT_W = PAGE_W - MARGIN_X * 2;

  // Membrete/Pie: dentro de márgenes y sin estirar
  const HEADER_MAX_H = 14;
  const FOOTER_MAX_H = 12;
  let headerDataURL = null, footerDataURL = null;
  let headerH = 10, footerH = 10;

  // Espaciados grandes entre bloques
  const GAP_AFTER_HEADER  = 14;  // encabezado → cuerpo
  const GAP_AFTER_BODY    = 18;  // cuerpo → firmantes
  const GAP_BETWEEN_SIGS  = 10;  // entre grupos de firmas
  const GAP_TO_FOOT_NOTES = 18;  // firmantes → CLONA/TA

  // Helpers -----------------------------------------------------
  function formatDateDMY(iso) {
    // "yyyy-mm-dd" -> "dd/mm/aaaa"
    if (!iso) return "";
    const [y, m, d] = iso.split("-");
    if (!y || !m || !d) return iso;
    return `${d.padStart(2,"0")}/${m.padStart(2,"0")}/${y}`;
  }

  async function toDataURL(url){
    // Más compatible: descarga y convierte a dataURL (evita CORS raros)
    const r = await fetch(url, {mode: 'cors'});
    const b = await r.blob();
    return await new Promise(res => {
      const fr = new FileReader();
      fr.onload = () => res(fr.result);
      fr.readAsDataURL(b);
    });
  }

  async function ensureHeaderFooterLoaded(){
    // Carga una sola vez; si falla, seguimos sin membrete/pie
    if (!headerDataURL) {
      try { headerDataURL = await toDataURL(HEADER_URL); } catch(e) { console.warn("Header no cargó:", e); }
    }
    if (!footerDataURL) {
      try { footerDataURL = await toDataURL(FOOTER_URL); } catch(e) { console.warn("Footer no cargó:", e); }
    }

    // Calcular alto proporcional con las imágenes cargadas
    function measure(dataURL){
      return new Promise(res=>{
        const img = new Image();
        img.onload = () => res({w: img.width, h: img.height});
        img.onerror = () => res(null);
        img.src = dataURL;
      });
    }

    if (headerDataURL) {
      const s = await measure(headerDataURL);
      if (s && s.w) headerH = Math.min(CONTENT_W * (s.h/s.w), HEADER_MAX_H);
    }
    if (footerDataURL) {
      const s = await measure(footerDataURL);
      if (s && s.w) footerH = Math.min(CONTENT_W * (s.h/s.w), FOOTER_MAX_H);
    }
  }

  function addHeaderFooter(doc){
    if (headerDataURL) doc.addImage(headerDataURL, "PNG", MARGIN_X, 10, CONTENT_W, headerH);
    if (footerDataURL) doc.addImage(footerDataURL, "PNG", MARGIN_X, PAGE_H - footerH - 8, CONTENT_W, footerH);
  }

  function topY(){ return 10 + (headerDataURL ? headerH : 0) + 12; }
  function bottomY(){ return PAGE_H - (footerDataURL ? footerH : 0) - 16; }

  function ensureSpace(doc, needed, yRef){
    if (yRef.value + needed > bottomY()){
      doc.addPage(); addHeaderFooter(doc); yRef.value = topY();
    }
  }

  function textBlock(doc, value, width, yRef, opt={}){
    const {
      fontSize=12, lineH=5.4, align="left",
      before=0, after=4, bold=false
    } = opt;
    const v = (value || "").toString().trim();
    if (!v) return;
    yRef.value += before;
    doc.setFont(undefined, bold ? "bold" : "normal");
    doc.setFontSize(fontSize);
    const lines = doc.splitTextToSize(v, width);
    const h = lines.length * lineH + 1;
    ensureSpace(doc, h, yRef);
    doc.text(lines, MARGIN_X, yRef.value, { align });
    yRef.value += h + after;
  }

  // -------------------------------------------------------------

  let pdfDoc = null;

  async function generarPDF(){
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      // Aseguramos membrete/pie (sin bloquear si falla)
      await ensureHeaderFooterLoaded();
      addHeaderFooter(doc);

      // Captura
      const fecha          = formatDateDMY(document.getElementById('fecha').value);
      const provincia      = document.getElementById('provincia').value;
      const nombreConvenio = document.getElementById('nombreConvenio').value;
      const numeroConvenio = document.getElementById('numeroConvenio').value;
      const vigencia       = document.getElementById('vigencia').value;

      const cuerpoNota     = document.getElementById('cuerpoNota').value;

      const auxiliar       = document.getElementById('auxiliar').value;
      const referente      = document.getElementById('referente').value;
      const subgerente     = document.getElementById('subgerente').value;
      const firmante       = document.getElementById('firmante').value;
      const firmanteEmail  = document.getElementById('firmanteEmail').value;

      const clona          = document.getElementById('clona').value;
      const conveniosClona = document.getElementById('conveniosClona').value;
      const numerosTA      = document.getElementById('numerosTA').value;

      // Composición tipo carta + más espacio entre bloques
      let y = { value: topY() };

      // 1) Encabezado (fecha y datos)
      textBlock(doc, fecha, CONTENT_W, y, {fontSize:12, after:6});
      textBlock(doc, nombreConvenio, CONTENT_W, y, {fontSize:12, after:2});
      textBlock(doc, `Convenio ${numeroConvenio} – ${provincia}`, CONTENT_W, y, {fontSize:12, after:GAP_AFTER_HEADER});

      // separador suave
      ensureSpace(doc, 6, y);
      doc.setDrawColor(170); doc.setLineWidth(0.35);
      doc.line(MARGIN_X, y.value, PAGE_W - MARGIN_X, y.value);
      y.value += GAP_AFTER_HEADER;

      // 2) A quien corresponda
      textBlock(doc, "A quien corresponda:", CONTENT_W, y, {fontSize:12, bold:true, after:10});

      // 3) Cuerpo (párrafos)
      textBlock(doc, cuerpoNota, CONTENT_W, y, {fontSize:12, lineH:5.6, after:GAP_AFTER_BODY});

      // 4) Firmantes (con roles predeterminados y negritas en títulos)
      textBlock(doc, "Por Jerárquicos Salud:", CONTENT_W, y, {fontSize:12, bold:true, after:8});
      textBlock(doc, `${auxiliar} – Comercial de Convenios`, CONTENT_W, y, {fontSize:12, after:6});
      textBlock(doc, `${referente} – Referente del Área Comercial de Convenios`, CONTENT_W, y, {fontSize:12, after:GAP_BETWEEN_SIGS});

      textBlock(doc, "Por el Convenio:", CONTENT_W, y, {fontSize:12, bold:true, after:8});
      textBlock(doc, firmante, CONTENT_W, y, {fontSize:12, after:3});
      textBlock(doc, firmanteEmail, CONTENT_W, y, {fontSize:11, after: (subgerente ? 8 : GAP_TO_FOOT_NOTES)});
      if ((subgerente||"").trim()!==""){
        textBlock(doc, `${subgerente} – Sub gerente`, CONTENT_W, y, {fontSize:12, after:GAP_TO_FOOT_NOTES});
      }

      // 5) CLONA y TA al pie (letra más chica)
      if (clona === "SI" && (conveniosClona||"").trim()!==""){
        textBlock(doc, "CLONA", CONTENT_W, y, {fontSize:10, bold:true, after:4});
        textBlock(doc, conveniosClona, CONTENT_W, y, {fontSize:10, lineH:4.6, after:8});
      }
      if ((numerosTA||"").trim()!==""){
        textBlock(doc, "TA", CONTENT_W, y, {fontSize:10, bold:true, after:4});
        textBlock(doc, numerosTA, CONTENT_W, y, {fontSize:10, lineH:4.6, after:2});
      }

      pdfDoc = doc;
      document.getElementById('preview').style.display = 'block';
      document.getElementById('preview').scrollIntoView({ behavior:'smooth' });

    } catch (err) {
      console.error(err);
      alert("Ups, hubo un error generando el PDF. Revisá la consola del navegador para más detalles.");
    }
  }

  function descargarPDF(){
    if (pdfDoc){
      const numero   = (document.getElementById('numeroConvenio').value || "").trim();
      const nombre   = (document.getElementById('nombreConvenio').value || "").trim();
      const vigencia = (document.getElementById('vigencia').value || "").trim();
      const safe = s => s.replace(/\s+/g,' ').replace(/[/\\:*?"<>|]+/g,'_').trim();
      const file = `${safe(numero)} - ${safe(nombre)} - ${safe(vigencia)}` || 'NotaSignatura';
      pdfDoc.save(`${file}.pdf`);
    }
  }

  // Exponer a los botones
  window.generarPDF = generarPDF;
  window.descargarPDF = descargarPDF;
</script>
