<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Generador de Nota de Signatura</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f2f4f8;margin:0;padding:24px}
    .container{max-width:920px;margin:0 auto;background:#fff;padding:28px 24px;border-radius:16px;box-shadow:0 12px 40px rgba(16,24,40,.08)}
    h1{margin:0 0 6px;text-align:center;color:#1f2937;font-size:26px}
    .subtitle{margin:0 0 20px;text-align:center;color:#6b7280;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .full{grid-column:1 / -1}
    label{display:block;font-weight:600;color:#111827;margin-bottom:6px;font-size:14px}
    input,select,textarea{width:100%;padding:12px;border:1.8px solid #e5e7eb;border-radius:10px;font-size:15px;font-family:inherit;background:#fff;outline:none;transition:border-color .2s}
    textarea{min-height:140px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:#6366f1}
    .section{background:#f9fafb;border:1px solid #eef2f7;padding:16px;border-radius:12px;margin:18px 0}
    .section h3{margin:0 0 10px;font-size:16px;color:#1f2937}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:700;background:#6366f1;color:#fff;width:100%;font-size:16px;box-shadow:0 8px 20px rgba(99,102,241,.25);transition:transform .15s}
    .btn:hover{transform:translateY(-1px)}
    .btn-secondary{background:#111827}
    .preview{margin-top:18px;display:none}
    .note{font-size:12px;color:#6b7280;margin-top:8px}
    .row-inline{display:flex;gap:12px;align-items:flex-end}
    .row-inline > div{flex:1}
    #richArea{min-height:140px;border:1.8px dashed #cbd5e1;border-radius:10px;padding:12px;background:#fff}
    #richArea:focus{outline:none;border-color:#6366f1}
    .hint{font-size:12px;color:#6b7280;margin-top:6px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}.row-inline{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìã Generador de Nota de Signatura</h1>
    <p class="subtitle">Complete los campos y genere el PDF con membrete y pie institucional</p>

    <!-- DATOS -->
    <div class="section">
      <h3>Datos del Convenio</h3>

      <div class="row-inline">
        <div>
          <label>Fecha (autom√°tica)</label>
          <input type="date" id="fecha" readonly>
        </div>
        <div>
          <label>N¬∫ de convenio (para autocompletar)</label>
          <div class="row-inline">
            <input type="text" id="numeroConvenioLookup" placeholder="Ej: 88">
            <button class="btn btn-secondary" style="width:auto" onclick="buscarDesdeSheets()">Buscar</button>
          </div>
          <div class="hint">Escrib√≠ el n√∫mero y toc√° ‚ÄúBuscar‚Äù para completar el formulario</div>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="full">
          <label>Nombre del Convenio</label>
          <input type="text" id="nombreConvenio">
        </div>
        <div class="full">
          <label>N√∫mero de Convenio</label>
          <input type="text" id="numeroConvenio">
        </div>
        <div>
          <label>Provincia</label>
          <input type="text" id="provincia">
        </div>
        <div>
          <label>Vigencia</label>
          <input type="date" id="vigencia">
        </div>
        <div class="full">
          <label>Correo del Convenio (prestador)</label>
          <input type="email" id="prestadorEmail">
        </div>
      </div>
    </div>

    <!-- CUERPO -->
    <div class="section">
      <h3>Cuerpo de la Nota</h3>
      <textarea id="cuerpoNota">Por medio del presente se acuerda </textarea>
    </div>

    <!-- ADJUNTOS -->
    <div class="section">
      <h3>Adjuntos (im√°genes / tabla)</h3>
      <div class="row-inline">
        <div class="full">
          <label>√Årea para pegar (Ctrl+V) im√°genes o tablas</label>
          <div id="richArea" contenteditable="true" placeholder="Peg√° ac√° im√°genes o una tabla"></div>
        </div>
      </div>
      <div style="margin-top:10px">
        <input type="file" id="imgInput" accept="image/*" multiple>
      </div>
    </div>

    <!-- FIRMANTES -->
    <div class="section">
      <h3>Firmantes</h3>
      <div class="grid">
        <div><label>Auxiliar</label><input id="auxiliar"></div>
        <div><label>Referente</label><input id="referente"></div>
        <div><label>Subgerente</label><input id="subgerente"></div>
        <div><label>Firmante del Convenio</label><input id="firmante"></div>
        <div><label>Cargo del Firmante</label><input id="cargoFirmante"></div>
      </div>
    </div>

    <!-- CLONA -->
    <div class="section">
      <h3>CLONA</h3>
      <div class="grid">
        <div>
          <label>¬øCorresponde?</label>
          <select id="clona" onchange="toggleClona()">
            <option value="NO">NO</option>
            <option value="SI">SI</option>
          </select>
        </div>
        <div class="full" id="clonaBox" style="display:none;">
          <label>Convenios relacionados</label>
          <textarea id="conveniosClona"></textarea>
        </div>
      </div>
    </div>

    <!-- TA -->
    <div class="section">
      <h3>TA</h3>
      <label>N√∫meros de TA</label>
      <input type="text" id="numerosTA">
    </div>

    <button class="btn" onclick="generarPDF()">üîÑ Generar PDF</button>
    <div class="note">Incluye membrete, pie, firmas y adjuntos</div>

    <div class="preview" id="preview">
      <p style="color:#10b981;font-weight:700;margin:10px 0 0">‚úÖ Documento listo:</p>
      <button class="btn" style="background:#10b981;margin-top:8px" onclick="descargarPDF()">üì• Descargar PDF</button>
    </div>
  </div>

  <!-- LIBRER√çAS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // ============= CONFIGURACI√ìN IM√ÅGENES =============
    const BASE = "https://conveniosjerarquicos.github.io/nota-signatura";
    const HEADER = `${BASE}/membrete.png`;
    const FOOTER = `${BASE}/pie.png`;

    let headerImg, footerImg, pdfDoc = null;

    // Fecha autom√°tica
    document.getElementById("fecha").value = new Date().toISOString().slice(0,10);

    function toggleClona(){
      document.getElementById("clonaBox").style.display = 
        document.getElementById("clona").value === "SI" ? "block" : "none";
    }

    // ====== Cargar im√°genes ======
    function loadImage(url){
      return new Promise((res,rej)=>{
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = ()=>res(img);
        img.onerror = ()=>rej();
        img.src = url;
      });
    }

    async function ensureImages(){
      if(!headerImg) headerImg = await loadImage(HEADER);
      if(!footerImg) footerImg = await loadImage(FOOTER);
    }

    // ====== Generar PDF ======
    async function generarPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      await ensureImages();

      // Insertar membrete y pie
      doc.addImage(headerImg, "PNG", 10, 10, 190, 20);
      doc.addImage(footerImg, "PNG", 10, 270, 190, 15);

      let y = 40;
      const add = (text, size=12, bold=false, spacing=6)=>{
        doc.setFontSize(size);
        doc.setFont("helvetica", bold?"bold":"normal");
        doc.text(text, 20, y);
        y += spacing;
      }

      add(document.getElementById("fecha").value);
      add(document.getElementById("nombreConvenio").value);
      add(`Convenio ${document.getElementById("numeroConvenio").value} ‚Äì ${document.getElementById("provincia").value}`);
      add(document.getElementById("prestadorEmail").value,11,false,10);
      add("A quien corresponda:",12,true,10);
      add(document.getElementById("cuerpoNota").value,12,false,10);
      add(`${document.getElementById("firmante").value} ‚Äî ${document.getElementById("cargoFirmante").value}`,12,false,8);

      pdfDoc = doc;
      document.getElementById("preview").style.display = "block";
    }

    function descargarPDF(){
      if(pdfDoc) pdfDoc.save("Nota-de-Signatura.pdf");
    }

    // ====== AUTOCOMPLETAR DESDE SHEETS ======
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTtwmE86YOrUU_3zaUAY2mXfwGrxe3f3sUdoI3ckQfj0cs3D1R46SzXH4tStGBiaVe6PiQFIR5DQ_U0/pub?gid=0&single=true&output=csv";

    async function buscarDesdeSheets(){
      const numero = (document.getElementById("numeroConvenioLookup").value || "").trim();
      if(!numero){ alert("Ingres√° un n√∫mero de convenio"); return; }

      const res = await fetch(SHEET_CSV);
      const csv = await res.text();
      const data = Papa.parse(csv, {header:true}).data;

      const match = data.find(r => String(r.NumeroConvenio).trim() === numero);
      if(!match){ alert("No se encontr√≥ ese n√∫mero en la hoja"); return; }

      const map = {
        numeroConvenio:"NumeroConvenio",
        nombreConvenio:"NombreConvenio",
        provincia:"Provincia",
        vigencia:"Vigencia",
        prestadorEmail:"PrestadorEmail",
        auxiliar:"Auxiliar",
        referente:"Referente",
        subgerente:"Subgerente",
        firmante:"Firmante",
        cargoFirmante:"CargoFirmante",
        cuerpoNota:"CuerpoNota"
      };
      Object.entries(map).forEach(([id,key])=>{
        if(match[key]) document.getElementById(id).value = match[key];
      });

      alert("‚úî Datos completados desde la hoja");
    }
  </script>
</body>
</html>
